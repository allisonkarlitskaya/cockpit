name: node_modules
on:
  pull_request_target

jobs:
  check:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Clone upstream repository
        uses: actions/checkout@v2

      - name: Check node_modules consistency
        run: |
            set -ux

            get_ref_hash() {
                local ref="$1"
                local type="$2"
                local name="$3"

                local script='s/^[[:digit:]]* '"${type}"' \([[:xdigit:]]*\)\t'"${name}"'$/\1/p'
                git cat-file -p "${ref}":./ | sed -ne "${script}"
            }

            pull_request="${{ github.event.pull_request.head.sha }}"
            pull_request_node_modules="$(get_ref_hash "${pull_request}" commit node_modules)"
            pull_request_package_json="$(get_ref_hash "${pull_request}" blob package.json)"

            GITHUB_BASE="${GITHUB_BASE:-cockpit-project/cockpit}"
            GITHUB_REPOSITORY="${GITHUB_BASE%/*}/node-cache"
            HTTPS_REMOTE="https://github.com/${GITHUB_REPOSITORY}"

            git fetch "${HTTPS_REMOTE}" "${pull_request_node_modules}"

            pull_request_node_modules_package_json="$(get_ref_hash "${pull_request_node_modules}" blob .package.json)"
            git diff "${pull_request_node_modules_package_json}" "${pull_request_package_json}"

      - name: npm install
        if: ${{ failure() }}
        run: |
          set -ux

          pull_request="${{ github.event.pull_request.head.sha }}"

          mkdir work
          git cat-file blob "${pull_request}:./package.json" > work/package.json

          # run the container to create _only_ work/node_modules
          local container="$(podman create -u node -w /home/node/work node:14 npm install --ignore-scripts)"
          tar --create work | podman container cp - "${container}:/home/node"
          podman container start -a "${container}" 2>&1 | tee work/npm-install-log
          podman container cp "${container}:/home/node/work" - | tar --get work/node_modules
          podman container rm -f "${container}"

          # double check that we got what we started with
          diff -u work/package.json work/node_modules/.package.json

          # no tricky stuff plz
          find work -name '.git*' -not -name '.github' -delete

          # produce the git commit
          export GIT_DIR=node-cache.git
          export GIT_WORK_TREE=work/node_modules
          git init
          git add --all
          git commit -m "$(cat work/npm-install-log)"
          git tag -f "$(git rev-parse HEAD)" HEAD
          rm -rf work
