name: node_modules
on:
  pull_request_target

jobs:
  check:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      GIT_DIR: git-dir.git
      pull_request: ${{ github.event.pull_request.head.sha }}

    steps:
      - name: Set up work area
        run: |
            set -ux

            git init -b main

            git config user.name "GitHub Workflow"
            git config user.email "cockpituous@cockpit-project.org"

            git remote add origin "${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}"
            git remote add cache "${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY%/*}/node-cache"

      - name: Fetch pull request
        run: git fetch origin "${pull_request}"

      - name: Fetch and check node_modules submodule
        run: |
            set -ux

            get_ref_hash() {
                local ref="$1"
                local type="$2"
                local name="$3"

                local script='s/^[[:digit:]]* '"${type}"' \([[:xdigit:]]*\)\t'"${name}"'$/\1/p'
                git cat-file -p "${ref}": | sed -ne "${script}"
            }

            pull_request_node_modules="$(get_ref_hash "${pull_request}" commit node_modules)"
            test -n "${pull_request_node_modules}"
            git fetch cache "${pull_request_node_modules}"

            pull_request_package_json="$(get_ref_hash "${pull_request}" blob package.json)"
            pull_request_node_modules_package_json="$(get_ref_hash "${pull_request_node_modules}" blob .package.json)"
            test -n "${pull_request_package_json}"
            test -n "${pull_request_node_modules_package_json}"

            git diff "${pull_request_node_modules_package_json}" "${pull_request_package_json}"

      - name: npm install
        if: ${{ failure() }}
        run: |
          set -ux

          podman() {
            sudo docker "$@"
          }

          git cat-file blob "${pull_request}:package.json" > package.json

          # run npm
          container="$(podman create -u node -w /home/node node:14 npm install --ignore-scripts)"
          podman cp package.json "${container}:/home/node/package.json"
          podman start -a "${container}" 2>&1 | tee npm-install-log
          podman cp "${container}:/home/node" - | tar --get node/package.json node/node_modules node/package-lock.json
          podman rm -f "${container}"

          # double check that we got what we started with
          diff -u package.json node/package.json

          # no tricky stuff plz
          find node -name '.git*' -not -name '.github' -delete

          # add the metadata files
          mv node/package.json      node/node_modules/.package.json
          mv node/package-lock.json node/node_modules/.package-lock.json

          # produce the git commit
          git --work-tree=node/node_modules add --all
          git --work-tree=node/node_modules commit -q -F - < npm-install-log
          tag="sha-$(git rev-parse HEAD)"
          git tag "${tag}"
          rm -rf node_modules

          # push the git commit
          git push cache "${tag}"
