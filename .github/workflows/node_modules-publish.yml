name: node_modules publish
on:
  workflow_run:
    workflows: node_modules
    types: [completed]

jobs:
  push:
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest
    timeout-minutes: 5
    env:
      GIT_DIR: git-dir.git
      HEAD_SHA: ${{ github.event.workflow_run.pull_requests[0].head.sha }}
      BASE_SHA: ${{ github.event.workflow_run.pull_requests[0].base.sha }}
      PULL_URL: ${{ github.event.workflow_run.pull_requests[0].url }}

    steps:
      - name: Set up work area
        run: |
            set -ux

            git init -b main

            git config credential.helper store
            git config user.name "GitHub Workflow"
            git config user.email "cockpituous@cockpit-project.org"

            git remote add origin "${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}"
            git remote add cache "${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY%/*}/node-cache"

      - name: Fetch base branch
        run: git fetch --depth=1 origin "${HEAD_SHA}"

      - name: Fetch pull request
        run: git fetch --depth=1 origin "${BASE_SHA}"

      - name: Ensure no workflow changes
        run: git diff --exit-code "${BASE_SHA}..${HEAD_SHA}" -- .github

      - name: Generate diff between base and PR package.json
        run: git diff "${BASE_SHA}..${HEAD_SHA}" -- package.json > package.json.diff

      - name: Download npm install artifacts
        # 2.14.0; if you update this, audit the diff and ensure that it does not leak/abuse secrets
        uses: dawidd6/action-download-artifact@b9571484721e8187f1fd08147b497129f8972c74
        with:
          name: artifact
          workflow: node_modules-pull_request.yml
          run_id: ${{ github.event.workflow_run.id }}
          path: artifact

      - name: Verify package.json matches PR head commit
        run: |
          set -ux
          git cat-file blob "${HEAD_SHA}:package.json" > package.json
          diff -u package.json artifact/package.json
          rm package.json

      - name: Unpack node_modules tar
        run: |
          set -ux
          tar -xf artifact/node_modules.tar --exclude '.git*' node_modules
          rm artifact/node_modules.tar

      - name: Stage git commit
        run: |
          set -ux
          cat - artifact/npm-install.log > commit-message <<EOF
          PR: $(sed 's@//api.@//@; s@/repos/@/@; s@/pulls/@/pull/@;' <<< "${PULL_URL}")

          EOF
          rm artifact/npm-install.log
          mv artifact/package.json node_modules/.package.json
          mv artifact/package-lock.json node_modules/.package-lock.json
          rmdir artifact

          echo /.cache >> node_modules/.gitignore
          git --work-tree node_modules add --all
          git --work-tree node_modules commit --quiet -F - < commit-message
          rm -rf node_modules

      - name: Configure cockpituous credentials
        run: echo 'https://token:${{ secrets.COCKPITUOUS_TOKEN }}@github.com' > ~/.git-credentials

      - name: Tag and push
        run: |
          set -ux
          sha="$(git rev-parse HEAD)"
          echo -n "${sha}" > sha
          git tag "sha-${sha}"
          git push cache tag "sha-${sha}"

      - name: Comment on PR
        uses: actions/github-script@v3
        with:
          script: |
            const fs = require('fs');

            body = `\`node_modules\` rebuild complete for the following changes:

            \`\`\`diff
            ${fs.readFileSync('package.json.diff')}\`\`\`

            The following commands will incorporate the changes locally:

            \`\`\`sh
            tools/node-modules checkout ${fs.readFileSync('sha')}
            git commit -om 'node_modules changes' node_modules
            \`\`\`

            ...at which point you should rebase your changes.`;

            const { repo: { owner, repo }, payload: { workflow_run: { pull_requests } } } = context;
            for (const { number: issue_number } of pull_requests) {
              github.issues.createComment({ owner, repo, issue_number, body });
            }
