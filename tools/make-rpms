#!/bin/bash
# This file is part of Cockpit.
#
# Copyright (C) 2015 Red Hat, Inc.
#
# Cockpit is free software; you can redistribute it and/or modify it
# under the terms of the GNU Lesser General Public License as published by
# the Free Software Foundation; either version 2.1 of the License, or
# (at your option) any later version.
#
# Cockpit is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
# Lesser General Public License for more details.
#
# You should have received a copy of the GNU Lesser General Public License
# along with Cockpit; If not, see <http://www.gnu.org/licenses/>.

set -euf

base=$(cd $(dirname $0)/../; pwd -P)

usage()
{
    echo "usage: make-rpms [--quick] [--verbose] [--build-in-place | tarball]"
}

build_in_place=""
quiet="--quiet"
check=""

args=$(getopt -o "h,i,q,v" -l "help,build-in-place,quick,verbose" -- "$@")
eval set -- "$args"
while [ $# -gt 0 ]; do
    case $1 in
    -i|--build-in-place)
        build_in_place=1
        ;;
    -v|--verbose)
        quiet=""
        ;;
    -q|--quick)
        check="--nocheck"
        ;;
    -h|--help)
        usage
        exit 0
        ;;
    --)
        shift
        break
        ;;
    esac
    shift
done

if [ $# -gt 1 -o $# = 1 -a -n "${build_in_place}" ]; then
    usage
    exit 2
fi

tmpdir=$(mktemp -d $PWD/rpm-build.XXXXXX)

if [ -n "${build_in_place}" ]; then
    test -f "${base}/configure" || NOCONFIGURE=1 "${base}/autogen.sh"
    version="$(sed -n "s/^PACKAGE_VERSION='\(.*\)'\$/\1/p" "${base}/configure")"
    test -n "${version}"

    spec="${tmpdir}/cockpit.spec"
    sed "s/^Version:.*$/Version: ${version}/" "${base}/tools/cockpit.spec" > "${spec}"
    "${base}/tools/gen-spec-dependencies" "${spec}"

    # unfortunately, this can't contain newlines
    ensure_configured='ensure_configured() { \
        args_checksum="$(echo "$*" | sha256sum - | cut -c1-64)"; \
        test -f Makefile -a config.checksum -nt Makefile && \
            test "$(cat config.checksum)" = "${args_checksum}" && \
                return; \
        test -f Makefile && make distclean; \
        ./configure "$@"; \
        echo "${args_checksum}" > config.checksum; \
    }; \
    ensure_configured'

    defines=(
        --define "_build_in_place 1"
        --define "_builddir $base"
        # the gnuconfig hack doesn't apply to Cockpit and is broken with our configure tricks
        --define "_configure_gnuconfig_hack 0"
        --define "_configure ${ensure_configured}"
        # add 'wip' to version number
        --define "wip wip"
    )
    cmd="-bb ${spec}"
else
    defines=(
        --define "_builddir $tmpdir"
    )
    srpm="$($base/tools/make-srpm ${1-})"
    cmd="-rb ${srpm}"
fi

rpmbuild $check $quiet \
    --define "_sourcedir $tmpdir" \
    --define "_specdir $tmpdir" \
    --define "_srcrpmdir $tmpdir" \
    --define "_rpmdir $tmpdir/output" \
    --define "_buildrootdir $tmpdir/build" \
    "${defines[@]}" ${cmd}

find $tmpdir/output -name '*.rpm' -printf '%f\n' -exec mv {} . \;
rm -r $tmpdir
