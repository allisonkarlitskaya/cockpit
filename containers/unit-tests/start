#!/bin/sh
set -eu

cd "$(realpath -m "$0"/../../..)"

image='ghcr.io/cockpit-project/unit-tests:latest'
flags='--network=none' # disabled for 'shell'

while test $# -gt 0; do
  case "$1" in
    --docker) docker="docker";;
    --podman) docker="podman";;
    CC=*) ccarg="--env=$1";;
    :*) image=ghcr.io/cockpit-project/unit-tests"$1";;
    shell) flags='-it'; cmd="/bin/bash";;
    build|dist|distcheck|check-memory) cmd="cockpit/containers/unit-tests/run.sh $1";;
    *) echo "Unknown option '$1'"; exit 1;;
  esac
  shift
done

if test -z "${cmd:-}"; then
  echo 'Must specify a scenario or `shell`'
  exit 1
fi

if test -z "${docker:=$(which podman || which docker || true)}"; then
  echo 'Neither podman nor docker are installed'
  exit 1
fi

mkdir -p tmp
containers/unit-tests/create-pack > tmp/unpack.sh
sed -ne 's/^# //p' tmp/unpack.sh | tar c -T - -C tmp unpack.sh > tmp/pack.tar

${docker} run \
    --rm \
    ${flags} \
    --shm-size=512M \
    -v "$(pwd)/tmp/pack.tar":/pack.tar:ro,z \
    ${ccarg:+"$ccarg"} \
    -- "$image" $cmd
